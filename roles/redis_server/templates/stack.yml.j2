services:
  redis:
{% if redis_server_tls %}
    image: redis-tls
    build:
      context: ./redis-tls
      args:
        STEP_VERSION: {{ redis_server_step_docker_version }}
        REDIS_VERSION: {{ redis_server_docker_version }}
        TLS_CA_HOST: {{ redis_server_tls_ca_host }}
        TLS_CA_PORT: {{ redis_server_tls_ca_port }}
        TLS_CA_FINGERPRINT: {{ redis_server_tls_ca_fingerprint }}
{% else %}
    image: bitnami/redis:{{ redis_server_docker_version }}
{% endif %}
    container_name: redis
    restart: always
    stop_grace_period: 1m
    environment:
      # ACL includes password
      ALLOW_EMPTY_PASSWORD: yes
      REDIS_ACLFILE: /run/secrets/users.acl
      REDIS_REPLICATION_MODE: {{ redis_server_replication_mode }}
      REDIS_MASTER_HOST: {{ redis_server_master_host }}
      REDIS_MASTER_PORT_NUMBER: {{ redis_server_master_port }}
      REDIS_MASTER_PASSWORD_FILE: /run/secrets/redis-password
      REDIS_REPLICA_IP: {{ redis_server_replication_host }}
{% if redis_server_tls %}
      TLS_DOMAINS: {{ redis_server_tls_domains }}
      TLS_USERNAME: {{ redis_server_tls_username }}
      TLS_PASSWORD_FILE: /run/secrets/tls-password
{% endif %}
    secrets:
      - redis-password
      - users.acl
{% if redis_server_tls %}
      - tls-password
      - acme-rfc2136.ini
{% endif %}
    ports:
      - 6379:6379
    volumes:
      - redis:/bitnami/redis/data

secrets:
  redis-password:
    file: ./redis-password
  users.acl:
    file: ./users.acl
{% if redis_server_tls %}
  tls-password:
    file: ./tls-password
  acme-rfc2136.ini:
    file: ./acme-rfc2136.ini
{% endif %}

networks:
  default:
    name: redis

volumes:
  redis:
    name: redis
