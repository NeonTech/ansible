- name: Install required packages
  ansible.builtin.apt:
    update_cache: true
    name:
      - yubikey-manager
      - libpcsclite-dev
      - gcc
      - make
      - pkg-config
    state: present

- name: Register version
  ansible.builtin.command: step-ca version
  changed_when: false
  ignore_errors: true
  register: step_ca_version_cmd

- name: (Re)install
  when: step_ca_version_cmd.rc != 0 or step_ca_version not in step_ca_version_cmd.stdout
  block:
    - name: Create temporary download file
      ansible.builtin.tempfile:
        suffix: "{{ step_ca_download_filename }}"
        state: file
      register: step_ca_download_file
    - name: Download "{{ step_ca_download_filename }}"
      ansible.builtin.get_url:
        url: https://github.com/smallstep/certificates/releases/download/v{{ step_ca_version }}/{{ step_ca_download_filename }}
        checksum: sha256:{{ step_ca_download_checksum }}
        dest: "{{ step_ca_download_file.path }}"
        mode: "0600" # -rw-------
    - name: Uninstall previous version
      ansible.builtin.file:
        path: /usr/local/step-ca
        state: absent
    - name: Create installation directory
      ansible.builtin.file:
        path: /usr/local/step-ca
        mode: "0755" # drwxr-xr-x
        state: directory
    - name: Install version "{{ step_ca_version }}"
      ansible.builtin.unarchive:
        src: "{{ step_ca_download_file.path }}"
        remote_src: true
        dest: /usr/local/step-ca
    # https://github.com/smallstep/certificates/issues/2013
    - name: Patch .version.sh
      ansible.builtin.replace:
        path: /usr/local/step-ca/.version.sh
        regexp: '^#!\/usr\/bin\/env sh$'
        replace: "#!/usr/bin/env bash"
    - name: Bootstrap
      community.general.make:
        chdir: /usr/local/step-ca
        target: bootstrap
    - name: Build
      community.general.make:
        chdir: /usr/local/step-ca
        target: build
        params:
          GO_ENVS: CGO_ENABLED=1
    - name: Add CAP_NET_BIND_SERVICE capability
      community.general.capabilities:
        path: /usr/local/step-ca/bin/step-ca
        capability: CAP_NET_BIND_SERVICE=+eip
        state: present
    - name: Register binaries
      ansible.builtin.find:
        path: /usr/local/step-ca/bin
        file_type: file
      register: step_ca_bin
    - name: Create symbolic links with binaries
      ansible.builtin.file:
        src: "{{ item.path }}"
        dest: /usr/local/bin/{{ item.path | basename }}
        mode: "0755" # -rwxr-xr-x
        state: link
      loop: "{{ step_ca_bin.files }}"
    - name: Delete temporary download file
      ansible.builtin.file:
        path: "{{ step_ca_download_file.path }}"
        state: absent

- name: Create user "{{ step_ca_user_name }}"
  ansible.builtin.user:
    name: "{{ step_ca_user_name }}"
    uid: "{{ step_ca_user_id }}"
    password: "!"
    create_home: true
    state: present

- name: Create configuration directory
  ansible.builtin.file:
    path: /etc/step-ca
    owner: "{{ step_ca_user_name }}"
    group: "{{ step_ca_user_name }}"
    mode: "0700" # drwx------
    state: directory

- name: Register configuration file
  ansible.builtin.stat:
    path: /etc/step-ca/config/ca.json
  register: step_ca_json

- name: Initialize
  when: not step_ca_json.stat.exists
  become: true
  become_user: "{{ step_ca_user_name }}"
  block:
    - name: Create temporary provisioner password file
      ansible.builtin.tempfile:
        suffix: step_ca_provisioner_password
        state: file
      register: step_ca_provisioner_password_file
    - name: Copy provisioner password
      ansible.builtin.copy:
        content: "{{ step_ca_provisioner_password }}"
        dest: "{{ step_ca_provisioner_password_file.path }}"
        mode: "0600" # -rw------
    - name: Initilize
      environment:
        STEPPATH: /etc/step-ca
      ansible.builtin.command:
        argv:
          - step-ca
          - init
          - --name="{{ step_ca_name }}"
          - --dns="{{ step_ca_dns | join(',') }}"
          - --address="{{ step_ca_address }}"
          - --provisioner="{{ step_ca_provisioner_name }}"
          - --provisioner-password-file="{{ step_ca_provisioner_password_file.path }}"
          - --deployment-type=standalone
          - --remote-management
      changed_when: true
    - name: Delete temporary provisioner password file
      ansible.builtin.file:
        path: "{{ step_ca_provisioner_password_file.path }}"
        state: absent
